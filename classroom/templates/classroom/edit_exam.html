{% extends 'Users/layout.html' %}
{% load static %}

{% block title %}
    Edit Exam
{% endblock %}

{% block head %}
    <link rel="stylesheet" href="{% static 'css/bootstrap.min.css' %}">
    <link rel="stylesheet" href="{% static 'css/add_exam.css' %}">
    <!-- Add HTMX directly in this template -->
    <script src="https://unpkg.com/htmx.org@1.9.9"></script>
    <script>
        document.body.addEventListener('htmx:configRequest', function(evt) {
            evt.detail.headers['X-CSRFToken'] = '{{ csrf_token }}';
        });
    </script>
{% endblock %}

{% block content %}
    <!-- Main Content -->
    <div class="main-content">
        <div class="exam-form">
            <h1>Edit Exam</h1>
            
            <section class="exam-details">
                <h2>Exam Details</h2>
                <form method="post" action="{% url 'classroom:edit_exam' exam.id %}">
                    {% csrf_token %}
                    <div class="input-group">
                        <label for="exam_name">Exam Name</label>
                        {{ exam_form.exam_name }}
                        {% if exam_form.exam_name.errors %}
                            <div class="error">{{ exam_form.exam_name.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="input-group">
                        <label for="exam_class">Class</label>
                        {{ exam_form.exam_class }}
                        {% if exam_form.exam_class.errors %}
                            <div class="error">{{ exam_form.exam_class.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="input-group">
                        <label for="exam_date">Date</label>
                        {{ exam_form.exam_date }}
                        {% if exam_form.exam_date.errors %}
                            <div class="error">{{ exam_form.exam_date.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="input-group">
                        <label for="exam_time">Time</label>
                        {{ exam_form.exam_time }}
                        {% if exam_form.exam_time.errors %}
                            <div class="error">{{ exam_form.exam_time.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="input-group">
                        <label for="exam_duration">Duration (HH:MM:SS)</label>
                        {{ exam_form.exam_duration }}
                        {% if exam_form.exam_duration.errors %}
                            <div class="error">{{ exam_form.exam_duration.errors }}</div>
                        {% endif %}
                    </div>
                    <section class="questions-section">
                        <div class="questions-header">
                            <h2>Questions</h2>
                            <button type="button" 
                                    class="btn-add-question"
                                    hx-get="{% url 'classroom:add_question_form' %}"
                                    hx-target="#questions-container"
                                    hx-swap="beforeend"
                                    hx-vals='js:{count: document.querySelectorAll(".question-card").length}'>
                                + Add Question
                            </button>
                        </div>
                        
                        <div id="questions-container" hx-target="this">
                            <!-- Existing questions will be displayed here -->
                            {% for question in questions %}
                                <div class="question-card" data-number="{{ question.number }}">
                                    <div class="question-header">
                                        <span>Question {{ question.number }}</span>
                                        <button type="button" 
                                                class="btn-delete" 
                                                hx-delete="{% url 'classroom:delete_question' %}"
                                                hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
                                                hx-target="closest .question-card" 
                                                hx-swap="outerHTML"
                                                hx-trigger="click">
                                            ðŸ—‘
                                        </button>
                                    </div>
                                    <div class="question-content">
                                        <!-- Add a hidden input to store the question ID for existing questions -->
                                        <input type="hidden" name="question_{{ forloop.counter0 }}-id" value="{{ question.id }}">
                                        
                                        <div class="form-group">
                                            {{ question.form.question_text.label_tag }}
                                            {{ question.form.question_text }}
                                        </div>
                                        <div class="options-container">
                                            <div class="form-group">
                                                {{ question.form.option1.label_tag }}
                                                {{ question.form.option1 }}
                                            </div>
                                            <div class="form-group">
                                                {{ question.form.option2.label_tag }}
                                                {{ question.form.option2 }}
                                            </div>
                                            <div class="form-group">
                                                {{ question.form.option3.label_tag }}
                                                {{ question.form.option3 }}
                                            </div>
                                            <div class="form-group">
                                                {{ question.form.option4.label_tag }}
                                                {{ question.form.option4 }}
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            {{ question.form.correct_option.label_tag }}
                                            {{ question.form.correct_option }}
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </section>
                    <button type="submit" class="btn btn-primary">Update Exam</button>
                </form>
            </section>
        </div>
    </div>
{% endblock %}

{% block script %}
    <script src="{% static 'js/create_exam.js' %}"></script>
{% endblock %}